# Quick Reference: Monorepo Commands & Concepts

## Essential Commands

### Setup

```bash
pnpm install              # Install all workspace dependencies
pnpm install --ignore-scripts  # Install without native module compilation
```

### Build

```bash
pnpm build                # Build all packages (respects dependency order)
pnpm turbo run clean      # Clean all build outputs
```

### Development

```bash
pnpm dev                  # Watch mode with auto-rebuild
cd apps/mcp-server && pnpm build --watch  # Watch specific package
```

### Testing & Quality

```bash
pnpm test                 # Run all tests
pnpm lint                 # Lint all packages
pnpm format               # Format with Prettier
pnpm outdated             # Check for outdated packages
pnpm audit                # Run security audit
pnpm update               # Update packages interactively
```

### Running Applications

#### MCP Server

```bash
# Recommended (ensures native module compatibility)
npx -p better-sqlite3 .

# Alternative (if better-sqlite3 installed locally)
node apps/mcp-server/dist/index.js
```

#### Feature Explorer

```bash
# Run the terminal UI
pnpm --filter @gcapnias/feature-explorer start

# Or directly
node apps/feature-explorer/dist/index.js
```

---

## Package Management

### Add Dependencies

```bash
# To workspace root (tooling)
pnpm add -D -w <package>

# To specific package
cd packages/shared-types
pnpm add <package>

# Workspace dependency
pnpm add @gcapnias/shared-types@workspace:*
```

### Update Dependencies

```bash
pnpm update               # Update all dependencies
pnpm update -r            # Update recursively in all packages
```

---

## Workspace Protocol

```json
{
  "dependencies": {
    "@gcapnias/core": "workspace:*", // Latest in workspace
    "@gcapnias/utils": "workspace:^1.0.0" // Version constraint
  }
}
```

**On publish**, `workspace:*` becomes actual version (e.g., `1.2.3`).

---

## Turborepo Pipeline

### Configuration Patterns

```json
{
  "tasks": {
    "build": {
      "dependsOn": ["^build"], // Wait for upstream packages
      "outputs": ["dist/**"] // Cache these files
    },
    "dev": {
      "cache": false, // Don't cache dev tasks
      "persistent": true // Long-running process
    }
  }
}
```

### Cache Management

```bash
# Clear cache
rm -rf .turbo

# Force rebuild (ignore cache)
pnpm turbo run build --force

# Check cache status
pnpm turbo run build --dry-run
```

---

## TypeScript Project References

### Package tsconfig.json

```json
{
  "compilerOptions": {
    "composite": true, // REQUIRED for references
    "declaration": true, // Generate .d.ts files
    "declarationMap": true // Enable go-to-definition
  },
  "references": [{ "path": "../shared-types" }]
}
```

### Build Commands

```bash
tsc --build                     # Build with project references
tsc --build --watch             # Watch mode
tsc --build --clean             # Clean outputs
```

---

## esbuild Configuration

### CLI Flags

```bash
esbuild src/index.ts \
  --bundle \                    # Bundle all imports
  --platform=node \             # Target Node.js
  --external:better-sqlite3 \   # Don't bundle this module
  --banner:js="#!/usr/bin/env node" \  # Add shebang
  --outfile=dist/index.js
```

### Common Patterns

```bash
# Library (don't bundle dependencies)
esbuild --bundle --external:./node_modules/*

# Application (bundle everything except native modules)
esbuild --bundle --external:better-sqlite3

# Multiple entry points
esbuild src/*.ts --outdir=dist
```

---

## Native Modules (better-sqlite3)

### Installation Strategy

| Context     | Method                                                          |
| ----------- | --------------------------------------------------------------- |
| Development | `pnpm add -D better-sqlite3` (may fail, use `--ignore-scripts`) |
| Build       | Mark as `--external:better-sqlite3` in esbuild                  |
| Runtime     | `npx -p better-sqlite3 .` (ensures compatibility)               |
| Production  | Install in deployment environment                               |

### Why External?

- ✅ **Platform compatibility** - Native bindings must match OS/Node version
- ✅ **Deployment flexibility** - Build once, deploy anywhere
- ✅ **Version matching** - Runtime Node.js version matches binary

### Common Errors

```text
Error: Cannot find module 'better-sqlite3'
→ Solution: npx -p better-sqlite3 .

Error: Module did not self-register
→ Solution: Node.js version mismatch, reinstall or use npx
```

---

## Package Structure

### Internal Package (packages/)

```text
packages/my-package/
├── src/
│   └── index.ts
├── dist/              # Generated by tsc
├── package.json       # name: "@gcapnias/my-package"
└── tsconfig.json      # composite: true
```

**package.json:**

```json
{
  "name": "@gcapnias/my-package",
  "type": "module",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "scripts": {
    "build": "tsc --build",
    "dev": "tsc --build --watch"
  }
}
```

### Application (apps/)

```text
apps/my-app/
├── src/
│   └── index.ts
├── dist/              # Generated by esbuild
├── package.json       # name: "@gcapnias/my-app"
└── tsconfig.json
```

**package.json:**

```json
{
  "name": "@gcapnias/my-app",
  "type": "module",
  "bin": "./dist/index.js",
  "scripts": {
    "build": "esbuild src/index.ts --bundle --outfile=dist/index.js",
    "start": "node dist/index.js"
  },
  "dependencies": {
    "@gcapnias/my-package": "workspace:*"
  }
}
```

---

## Configuration Files

### .npmrc

```ini
engine-strict=true              # Enforce engines field
link-workspace-packages=true    # Auto-link workspace deps
shared-workspace-lockfile=true  # Single lockfile
save-exact=true                 # Pin exact versions
```

### pnpm-workspace.yaml

```yaml
packages:
  - 'packages/*' # All packages in packages/
  - 'apps/*' # All apps in apps/
  - '!**/test/**' # Exclude test directories
```

### turbo.json

```json
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    }
  }
}
```

---

## Git Workflow

### Initial Commit

```bash
git add .
git commit -m "chore: initialize monorepo"
```

### Conventional Commits

```bash
feat(api-core): add database connection pooling
fix(mcp-server): resolve native module loading issue
docs: update setup guide with troubleshooting
chore(deps): update typescript to 5.3.0
```

---

## Debugging

### Check Workspace Structure

```bash
pnpm list -r --depth 0        # List all workspace packages
pnpm why <package>            # Show why package is installed
```

### Verify Dependencies

```bash
pnpm install --frozen-lockfile  # Use existing lockfile
pnpm install --force            # Force reinstall
```

### TypeScript Issues

```bash
tsc --build --verbose          # Show build steps
tsc --build --clean            # Clean build artifacts
```

### Turborepo Issues

```bash
pnpm turbo run build --dry-run   # Show what would run
pnpm turbo run build --force     # Ignore cache
```

---

## Performance Tips

1. **Use Turborepo caching** - Speeds up CI/CD dramatically
2. **Parallel builds** - Turborepo builds independent packages in parallel
3. **Incremental TypeScript** - `composite: true` enables faster rebuilds
4. **pnpm store** - Reuses packages across projects

### CI/CD Optimization

```yaml
# .github/workflows/build.yml
- name: Cache Turborepo
  uses: actions/cache@v3
  with:
    path: .turbo
    key: turbo-${{ runner.os }}-${{ github.sha }}
    restore-keys: turbo-${{ runner.os }}-
```

---

## Common Pitfalls

| Problem                           | Solution                                            |
| --------------------------------- | --------------------------------------------------- |
| Workspace package not found       | Check `pnpm-workspace.yaml` and package `name`      |
| TypeScript errors across packages | Enable `composite: true` and `references`           |
| Native module bundle errors       | Always `--external:better-sqlite3`                  |
| Turborepo not rebuilding          | Clear cache: `rm -rf .turbo`                        |
| Version conflicts                 | Use `pnpm list` to diagnose, fix with `pnpm update` |

---

## Resources

- [pnpm Workspaces](https://pnpm.io/workspaces)
- [Turborepo Documentation](https://turbo.build/repo/docs)
- [TypeScript Project References](https://www.typescriptlang.org/docs/handbook/project-references.html)
- [esbuild Documentation](https://esbuild.github.io/)
- [better-sqlite3 Guide](https://github.com/WiseLibs/better-sqlite3/blob/master/docs/api.md)

---

## Quick Troubleshooting

```bash
# Start from scratch
rm -rf node_modules .turbo dist pnpm-lock.yaml
pnpm install
pnpm build

# Verify structure
tree -L 2 -I node_modules

# Check for errors
pnpm build 2>&1 | tee build.log
```
